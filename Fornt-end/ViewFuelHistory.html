<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>View Fuel History</title>
    <link rel="stylesheet" href="ViewHistory.css">
    <script src="HistoryManager.js" defer></script>
</head>
<body>
    <header>
        <h2 class="logo">hey</h2>
        <nav class="navigation">
            <a href="index.html">Home</a>
            <a href="Profile.html">Profile</a>
            <a href="#">Services</a>
            <a href="#">Quaso</a>
        </nav>
    </header>
    <div class="historyWrapper">
        <h2>Fuel Request History</h2>
        <div id="fuelHistoryContainer"></div>
    </div>
    <div style="display: flex; justify-content: center; gap: 20px; margin-top: 20px;">
        <button onclick="clearHistory()" class="btn">Clear History</button>
        <button onclick="viewProfile()" class="btn">View Profile</button>
        <button onclick="requestFuel()" class="btn">Place Order</button>
        <button onclick="viewCustomerHistory()" class="btn">View Customer History</button>
    </div>
    <script>
        function displayFuelHistory() {
            const historyContainer = document.getElementById('fuelHistoryContainer');
            const username = sessionStorage.getItem('username'); // Assuming username is stored in sessionStorage for identifying the user
            fetch(`http://localhost:3000/getFuelHistory/${username}`)
            .then(response => response.json())
            .then(fuelRequestHistory => {
                if (fuelRequestHistory && fuelRequestHistory.length > 0) {
                    const table = document.createElement('table');
                    table.setAttribute('border', '1');
                    const thead = document.createElement('thead');
                    const tbody = document.createElement('tbody');
        
                    const headRow = document.createElement('tr');
                    ['Order #', 'Gallons Requested', 'Fuel Type', 'Total Amount Due', 'Delivery Address', 'City', 'State', 'ZIP Code', 'Delivery Date'].forEach(heading => {
                        const th = document.createElement('th');
                        th.textContent = heading;
                        headRow.appendChild(th);
                    });
        
                    thead.appendChild(headRow);
                    table.appendChild(thead);
        
                    fuelRequestHistory.forEach(entry => {
                        const newRow = document.createElement('tr');
        
                        ['RequestID', 'GallonsRequested', 'FuelType', 'TotalAmountDue', 'DeliveryAddress', 'DeliveryCity', 'DeliveryState', 'DeliveryZipCode', 'DeliveryDate'].forEach(key => {
                            const td = document.createElement('td');
                            if (key === 'TotalAmountDue') {
                                td.textContent = `$${parseFloat(entry[key]).toFixed(2)}`;
                            } else if (key === 'DeliveryDate') {
                                const date = new Date(entry[key]);
                                const formattedDate = `${date.getMonth() + 1}/${date.getDate()}/${date.getFullYear()}`;
                                td.textContent = formattedDate;
                            } else {
                                td.textContent = entry[key];
                            }
                            newRow.appendChild(td);
                        });
        
                        tbody.appendChild(newRow);
                    });
        
                    table.appendChild(tbody);
                    historyContainer.appendChild(table);
                } else {
                    historyContainer.innerHTML = "<p>No fuel request history.</p>";
                }
            })
            .catch(error => {
                console.error('Error fetching fuel history:', error);
                historyContainer.innerHTML = "<p>Error loading fuel history. Please try again later.</p>";
            });
        }
        
        function clearHistory() {
            const username = sessionStorage.getItem('username'); // Assuming username is stored in sessionStorage
            if(confirm("Are you sure you want to clear all fuel history?")) {
                fetch(`http://localhost:3000/clearFuelHistory/${username}`, { method: 'DELETE' })
                .then(response => response.json())
                .then(data => {
                    console.log(data.message); // Log the server response
                    displayFuelHistory(); // Refresh the history display
                })
                .catch(error => {
                    console.error('Error clearing fuel history:', error);
                });
            }
        }
        
        function viewProfile() {
            window.location.href = 'Profile.html';
        }
        
        function requestFuel() {
            window.location.href = 'RequestFuelQuota.html';
        }
        
        window.onload = displayFuelHistory;
        //New code
        function viewCustomerHistory() {
    // Create a new container for the customer histories
    const customersHistoryContainer = document.createElement('div');
    customersHistoryContainer.id = 'customersHistoriesContainer';
    customersHistoryContainer.innerHTML = "<h2>Customers' Fuel Request Histories</h2>";

    // Place the new container below the buttons
    const buttonContainer = document.querySelector('div.historyWrapper').nextElementSibling;
    document.body.insertBefore(customersHistoryContainer, buttonContainer.nextSibling);

    // Fetch all users from the server
    fetch('http://localhost:3000/allUsers')
    .then(response => response.json())
    .then(users => {
        // Iterate over each user
        users.forEach(user => {
            // Optionally skip the admin's history by checking a condition, e.g., user.AccountType
            if (user.AccountType === 'Admin') {
                return;
            }

            // Fetch the user's history using the getFuelHistory endpoint
            fetch(`http://localhost:3000/getFuelHistory/${user.Username}`)
            .then(response => response.json())
            .then(history => {
                // Check if the user has history records
                if (history.length > 0) {
                    // Create a new table for the user's history
                    const table = document.createElement('table');
                    table.setAttribute('border', '1');
                    table.innerHTML = `<tr><th>Order #</th><th>Gallons Requested</th><th>Fuel Type</th><th>Total Amount Due</th><th>Delivery Address</th><th>City</th><th>State</th><th>ZIP Code</th><th>Delivery Date</th></tr>`;
                    history.forEach((entry, index) => {
                        // Populate the table with history data
                        let row = `<tr><td>${index + 1}</td><td>${entry.GallonsRequested}</td><td>${entry.FuelType}</td><td>$${parseFloat(entry.TotalAmountDue).toFixed(2)}</td><td>${entry.DeliveryAddress}</td><td>${entry.DeliveryCity}</td><td>${entry.DeliveryState}</td><td>${entry.DeliveryZipCode}</td><td>${new Date(entry.DeliveryDate).toLocaleDateString()}</td></tr>`;
                        table.innerHTML += row;
                    });

                    // Create a container div for the user's history and append the table to it
                    const userHistoryDiv = document.createElement('div');
                    userHistoryDiv.className = 'user-history';
                    userHistoryDiv.innerHTML = `<h3>History for ${user.Username}</h3>`;
                    userHistoryDiv.appendChild(table);

                    // Append the user's history div to the customer histories container
                    customersHistoryContainer.appendChild(userHistoryDiv);
                }
            })
            .catch(error => console.error('Error fetching user history:', error));
        });
    })
    .catch(error => console.error('Error fetching all users:', error));
}

        //New Code
        </script>
</body>
</html>
