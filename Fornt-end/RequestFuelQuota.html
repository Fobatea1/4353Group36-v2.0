<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Request Fuel Quota</title>
    <link rel="stylesheet" href="ViewHistory.css">
    <script src="HistoryManager.js" defer></script>
</head>
<body>
    <header>
        <h2 class="logo">hey</h2>
        <nav class="navigation">
            <a href="index.html">Home</a>
            <a href="Profile.html">Profile</a>
            <a href="#">Services</a>
            <a href="#">Quaso</a>
        </nav>
    </header>
    <div class="historyWrapper">
        <h2>Request Fuel Quota</h2>
        <form id="fuelQuotaForm">
            <label for="gallonsRequested">How many Gallons do you need:</label>
            <input type="number" id="gallonsRequested" name="gallonsRequested" required><br><br>

            <label for="deliveryState">Delivery State:</label>
            <input type="text" id="deliveryState" name="deliveryState" required readonly>
            <button type="button" onclick="changeState()" class="btn">Change State</button>
            <div id="newStateInput" style="display:none;">
                <select id="newState" name="newState">
                    <option value="">Select State</option>
                        <option value="AL">Alabama</option>
                        <option value="AK">Alaska</option>
                        <option value="AZ">Arizona</option>
                        <option value="AR">Arkansas</option>
                        <option value="CA">California</option>
                        <option value="CO">Colorado</option>
                        <option value="CT">Connecticut</option>
                        <option value="DE">Delaware</option>
                        <option value="FL">Florida</option>
                        <option value="GA">Georgia</option>
                        <option value="HI">Hawaii</option>
                        <option value="ID">Idaho</option>
                        <option value="IL">Illinois</option>
                        <option value="IN">Indiana</option>
                        <option value="IA">Iowa</option>
                        <option value="KS">Kansas</option>
                        <option value="KY">Kentucky</option>
                        <option value="LA">Louisiana</option>
                        <option value="ME">Maine</option>
                        <option value="MD">Maryland</option>
                        <option value="MA">Massachusetts</option>
                        <option value="MI">Michigan</option>
                        <option value="MN">Minnesota</option>
                        <option value="MS">Mississippi</option>
                        <option value="MO">Missouri</option>
                        <option value="MT">Montana</option>
                        <option value="NE">Nebraska</option>
                        <option value="NV">Nevada</option>
                        <option value="NH">New Hampshire</option>
                        <option value="NJ">New Jersey</option>
                        <option value="NM">New Mexico</option>
                        <option value="NY">New York</option>
                        <option value="NC">North Carolina</option>
                        <option value="ND">North Dakota</option>
                        <option value="OH">Ohio</option>
                        <option value="OK">Oklahoma</option>
                        <option value="OR">Oregon</option>
                        <option value="PA">Pennsylvania</option>
                        <option value="RI">Rhode Island</option>
                        <option value="SC">South Carolina</option>
                        <option value="SD">South Dakota</option>
                        <option value="TN">Tennessee</option>
                        <option value="TX">Texas</option>
                        <option value="UT">Utah</option>
                        <option value="VT">Vermont</option>
                        <option value="VA">Virginia</option>
                        <option value="WA">Washington</option>
                        <option value="WV">West Virginia</option>
                        <option value="WI">Wisconsin</option>
                        <option value="WY">Wyoming</option>
                </select>
                <button type="button" onclick="submitNewState()" class="btn">Submit State</button>
            </div><br><br>

            <label for="fuelType">Fuel Type:</label>
            <select id="fuelType" name="fuelType" required>
                <option value="1.50">Regular - $1.50/gallon</option>
                <option value="2.50">Diesel - $2.50/gallon</option>
                <option value="3.50">Premium - $3.50/gallon</option>
            </select><br><br>

            <label>Total Amount Due: </label>
            <span id="totalAmountDue">$0.00</span><br><br>

            <label for="deliveryAddress">Delivery Address:</label>
            <input type="text" id="deliveryAddress" name="deliveryAddress" required readonly><br>
            <button type="button" onclick="changeAddress()" class="btn">Change Address</button>
            <br>
            <div id="newAddressInput" style="display:none;">
                <input type="text" id="newAddress" placeholder="Enter new address">
                <button type="button" onclick="submitNewAddress()" class="btn">Submit Address</button>
            </div><br>

            <label for="city">City:</label>
            <input type="text" id="city" name="city" required readonly><br>
            <button type="button" onclick="changeCity()" class="btn">Change City</button>
            <div id="newCityInput" style="display:none;">
                <input type="text" id="newCity" placeholder="Enter new city">
                <button type="button" onclick="submitNewCity()" class="btn">Submit City</button>
            </div><br>
            <br>
            <label for="zipcode">Zipcode:</label>
            <input type="text" id="zipcode" name="zipcode" required readonly><br>
            <button type="button" onclick="changeZipcode()" class="btn">Change Zipcode</button>
            <div id="newZipcodeInput" style="display:none;">
                <input type="text" id="newZipcode" placeholder="Enter new zipcode">
                <button type="button" onclick="submitNewZipcode()" class="btn">Submit Zipcode</button>
            </div><br>

            <label for="deliveryDate">Request Delivery Date:</label>
            <input type="date" id="deliveryDate" name="deliveryDate" required><br><br>

            <button type="submit" class="btn" id="completeInfoBtn">Complete Info</button>
        </form>
        <div id="postSubmissionOptions">
            <button onclick="window.location.href='Profile.html'" class="btn">View Profile</button>
            <button onclick="window.location.href='ViewFuelHistory.html'" class="btn">View Fuel History</button>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const form = document.getElementById('fuelQuotaForm');
            form.addEventListener('submit', function(event) {
                event.preventDefault();
                submitFuelRequest();
            });

            loadDefaultAddress();
            addInputEventListeners();

            function submitFuelRequest() {
                const totalAmountDue = updateTotalAmountDue();
                const fuelRequestData = collectFormData(totalAmountDue);
                HistoryManager.addEntry(fuelRequestData);
                document.getElementById('postSubmissionOptions').style.display = 'block';
                alert('Fuel request submitted successfully!');
            }

            function collectFormData(totalAmountDue) {
                return {
                    gallonsRequested: parseInt(document.getElementById('gallonsRequested').value),
                    deliveryState: document.getElementById('deliveryState').value,
                    deliveryAddress: document.getElementById('deliveryAddress').value,
                    city: document.getElementById('city').value,
                    zipcode: document.getElementById('zipcode').value,
                    deliveryDate: document.getElementById('deliveryDate').value,
                    fuelType: document.getElementById('fuelType').options[document.getElementById('fuelType').selectedIndex].text,
                    pricePerGallon: calculatePricePerGallon(),
                    totalAmountDue
                };
            }

            function calculatePricePerGallon() {
                const basePrice = parseFloat(document.getElementById('fuelType').value);
                return (basePrice + calculateMargin(basePrice, document.getElementById('deliveryState').value, parseInt(document.getElementById('gallonsRequested').value))).toFixed(2);
            }

            function calculateMargin(pricePerGallon, deliveryState, gallonsRequested) {
                const locationFactor = deliveryState === 'TX' ? 0.02 : 0.04;
                const rateHistoryFactor = 0.01;
                const gallonsRequestedFactor = gallonsRequested > 1000 ? 0.02 : 0.03;
                const companyProfitFactor = 0.10;
                return pricePerGallon * (locationFactor - rateHistoryFactor + gallonsRequestedFactor + companyProfitFactor);
            }

            function addInputEventListeners() {
                ['input', 'change'].forEach(event => {
                    document.getElementById('gallonsRequested').addEventListener(event, updateTotalAmountDue);
                    document.getElementById('fuelType').addEventListener(event, updateTotalAmountDue);
                    document.getElementById('newState').addEventListener(event, function() {
                        updateTotalAmountDue();
                        document.getElementById('deliveryState').value = document.getElementById('newState').value;
                    });
                });
            }

            function updateTotalAmountDue() {
                const gallons = parseInt(document.getElementById('gallonsRequested').value || 0);
                const basePrice = parseFloat(document.getElementById('fuelType').value);
                const state = document.getElementById('deliveryState').value;
                const total = calculateTotalAmount(gallons, basePrice, state);
                document.getElementById('totalAmountDue').textContent = `$${total.toFixed(2)}`;
                return total;
            }

            function calculateTotalAmount(gallons, basePrice, state) {
                return gallons * (basePrice + calculateMargin(basePrice, state, gallons));
            }

            function loadDefaultAddress() {
                // Assuming the username is stored in sessionStorage and the user info is in localStorage
                const username = sessionStorage.getItem('username');  // Make sure 'username' is set in your session
                if (username) {
                    const userInfo = JSON.parse(localStorage.getItem(`userInfo_${username}`));  // Ensure this matches how data is stored
                    if (userInfo) {
                        document.getElementById('deliveryAddress').value = userInfo.address1 || '';
                        document.getElementById('city').value = userInfo.city || '';
                        document.getElementById('zipcode').value = userInfo.zipcode || '';
                        document.getElementById('deliveryState').value = userInfo.state || '';
                    }
                }
            }

            window.changeAddress = function() {
                document.getElementById('newAddressInput').style.display = 'block';
            };

            window.submitNewAddress = function() {
                const newAddress = document.getElementById('newAddress').value;
                if (newAddress) {
                    document.getElementById('deliveryAddress').value = newAddress;
                    document.getElementById('newAddressInput').style.display = 'none';
                } else {
                    alert("Please enter a valid address.");
                }
            };

            window.changeCity = function() {
                document.getElementById('newCityInput').style.display = 'block';
            };

            window.submitNewCity = function() {
                const newCity = document.getElementById('newCity').value;
                if (newCity) {
                    document.getElementById('city').value = newCity;
                    document.getElementById('newCityInput').style.display = 'none';
                } else {
                    alert("Please enter a valid city.");
                }
            };

            window.changeZipcode = function() {
                document.getElementById('newZipcodeInput').style.display = 'block';
            };

            window.submitNewZipcode = function() {
                const newZipcode = document.getElementById('newZipcode').value;
                if (newZipcode) {
                    document.getElementById('zipcode').value = newZipcode;
                    document.getElementById('newZipcodeInput').style.display = 'none';
                } else {
                    alert("Please enter a valid zipcode.");
                }
            };

            window.changeState = function() {
                document.getElementById('newStateInput').style.display = 'block';
            };

            window.submitNewState = function() {
                const newState = document.getElementById('newState').value;
                if (newState) {
                    document.getElementById('deliveryState').value = newState;
                    document.getElementById('newStateInput').style.display = 'none';
                    updateTotalAmountDue(); // Recalculate total when state changes
                } else {
                    alert("Please select a valid state.");
                }
            };
        });
    </script>
</body>
</html>
