<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Request Fuel Quota</title>
    <link rel="stylesheet" href="ViewHistory.css">
    <script src="HistoryManager.js" defer></script>
</head>
<body>
    <header>
        <h2 class="logo">hey</h2>
        <nav class="navigation">
            <a href="index.html">Home</a>
            <a href="Profile.html">Profile</a>
            <a href="#">Services</a>
            <a href="#">Quaso</a>
        </nav>
    </header>
    <br><br><br><br>
    <div class="historyWrapper">
        <h2>Request Fuel Quota</h2>
        <br>
        <form id="fuelQuotaForm">
            <label for="GallonsRequested">How many Gallons do you need:</label>
            <input type="number" id="GallonsRequested" name="GallonsRequested" required><br><br>

            <label for="FuelType">&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbspFuel Type:</label>
            <select id="FuelType" name="FuelType" required>
                <option value="0.56">Regular - $0.56/gallon</option>
                <option value="1.34">Diesel - $1.34/gallon</option>
                <option value="3.89">Premium - $3.89/gallon</option>
            </select><br><br>

            <label>&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbspTotal Amount Due: </label>
            <span id="TotalAmountDue">$0.00</span><br><br>

            <label for="DeliveryAddress">&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbspDelivery Address:</label>
            <input type="text" id="DeliveryAddress" name="DeliveryAddress" readonly><br><br>

            &nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp
            <button type="button" id="changeAddressBtn" class = "btn">Change address</button><br><br>

            <div id="newAddressContainer" style="display:none;">
                <label for="newAddress">&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp
                    Input new address:</label>
                <input type="text" id="newAddress" name="newAddress"><br>
                
                &nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp
            
                <button type="button" id="confirmAddressBtn" class = "btn">Confirm New Address</button><br><br>
            </div>

            <label for="DeliveryDate">&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbspRequest Delivery Date:</label>
            <input type="date" id="DeliveryDate" name="DeliveryDate" required><br><br>
            &nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp
            <button type="submit" id="completeInfoBtn" class = "btn">Complete Info</button>
        </form>
        <div id="postSubmissionOptions" style="display:none;">
            <button onclick="window.location.href='Profile.html'" class="btn">View Profile</button>
            <button onclick="window.location.href='ViewFuelHistory.html'" class="btn">View Fuel History</button>
        </div>
    </div>

    <script>
        document.getElementById('changeAddressBtn').addEventListener('click', function() {
            document.getElementById('newAddressContainer').style.display = 'block';
        });
        
        document.getElementById('confirmAddressBtn').addEventListener('click', function() {
            var newAddress = document.getElementById('newAddress').value;
            if(newAddress) {
                document.getElementById('deliveryAddress').value = newAddress;
                document.getElementById('newAddressContainer').style.display = 'none';
            } else {
                alert('Please enter a new address.');
            }
        });
        
        function calculateTotalAmount() {
            const gallons = document.getElementById('GallonsRequested').value;
            const pricePerGallon = document.getElementById('FuelType').value;
            const totalAmount = gallons * pricePerGallon;
            document.getElementById('TotalAmountDue').innerText = `$${totalAmount.toFixed(2)}`;
        }
        
        document.getElementById('GallonsRequested').addEventListener('input', calculateTotalAmount);
        document.getElementById('FuelType').addEventListener('change', calculateTotalAmount);
        
        document.getElementById('fuelQuotaForm').addEventListener('submit', function(event) {
            event.preventDefault();
        
            const GallonsRequested = document.getElementById('GallonsRequested').value;
            const DeliveryAddress = document.getElementById('DeliveryAddress').value || document.getElementById('newAddress').value;
            const DeliveryDate = document.getElementById('DeliveryDate').value;
            const FuelType = document.getElementById('FuelType').options[document.getElementById('FuelType').selectedIndex].text;
            const TotalAmountDue = document.getElementById('TotalAmountDue').innerText;
            const token = sessionStorage.getItem('token'); // Retrieve the token from sessionStorage
        
            const fuelRequestData = {
                GallonsRequested,
                DeliveryAddress,
                DeliveryDate,
                FuelType,
                TotalAmountDue,
                token  // Add the token to your fuelRequestData
            };
        
            HistoryManager.addEntry(fuelRequestData); // Pass the token along with the request data
        
            document.getElementById('postSubmissionOptions').style.display = 'block';
        });
        
        async function populateDeliveryAddress() {
            const username = sessionStorage.getItem('username');
            if (username) {
                try {
                    const response = await fetch(`http://localhost:3000/userInfo/${username}`);
                    const userInfo = await response.json();
                    if(userInfo.address) {
                        document.getElementById('deliveryAddress').value = userInfo.address;
                        calculateTotalAmount();
                    }
                } catch (error) {
                    console.error('Error fetching user info:', error);
                }
            }
        }
        
        window.onload = populateDeliveryAddress;
        </script>
</body>
</html>
