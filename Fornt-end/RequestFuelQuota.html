<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Request Fuel Quota</title>
    <link rel="stylesheet" href="RequestQuota.css">
    <script src="HistoryManager.js" defer></script>
</head>
<body>
    <header>
        <h2 class="logo">hey</h2>
        <nav class="navigation">
            <a href="index.html">Home</a>
            <a href="Profile.html">Profile</a>
            <a href="#">Services</a>
            <a href="#">Quaso</a>
        </nav>
    </header>
    <div class="requestWrapper">
        <h2>Request Fuel Quota</h2>
        <form id="fuelQuotaForm">
            <label for="gallonsRequested">How many Gallons do you need:</label>
            <input type="number" id="gallonsRequested" name="gallonsRequested" required><br><br>

            <label for="deliveryState">Delivery State:</label>
            <input type="text" id="deliveryState" name="deliveryState" required readonly><br>
            <button type="button" onclick="changeState()" class="btn">Change State</button>
            <div id="newStateInput" style="display:none;">
                <select id="newState" name="newState">
                    <option value="TX">Texas</option>
                    <option value="Other">Other</option>
                </select>
                <button type="button" onclick="submitNewState()" class="btn">Submit State</button>
            </div><br><br>

            <label for="fuelType">Fuel Type:</label>
            <select id="fuelType" name="fuelType" required>
                <option value="1.50">Regular - $1.50/gallon</option>
                <option value="2.50">Diesel - $2.50/gallon</option>
                <option value="3.50">Premium - $3.50/gallon</option>
            </select><br><br>

            <label>Total Amount Due: </label>
            <span id="totalAmountDue">$0.00</span><br><br>

            <label for="deliveryAddress">Delivery Address:</label>
            <input type="text" id="deliveryAddress" name="deliveryAddress" required readonly><br>
            <button type="button" onclick="changeAddress()" class="btn">Change Address</button>
            <div id="newAddressInput" style="display:none;">
                <input type="text" id="newAddress" placeholder="Enter new address">
                <button type="button" onclick="submitNewAddress()" class="btn">Submit Address</button>
            </div><br>

            <label for="city">City:</label>
            <input type="text" id="city" name="city" required readonly><br>
            <button type="button" onclick="changeCity()" class="btn">Change City</button>
            <div id="newCityInput" style="display:none;">
                <input type="text" id="newCity" placeholder="Enter new city">
                <button type="button" onclick="submitNewCity()" the "btn">Submit City</button>
            </div><br>

            <label for="zipcode">Zipcode:</label>
            <input type="text" id="zipcode" name="zipcode" required readonly><br>
            <button type="button" onclick="changeZipcode()" class="btn">Change Zipcode</button>
            <div id="newZipcodeInput" style="display:none;">
                <input type="text" id="newZipcode" placeholder="Enter new zipcode">
                <button type="button" onclick="submitNewZipcode()" class="btn">Submit Zipcode</button>
            </div><br>

            <label for="deliveryDate">Request Delivery Date:</label>
            <input type="date" id="deliveryDate" name="deliveryDate" required><br><br>

            <button type="submit" id="completeInfoBtn">Complete Info</button>
        </form>
        <div id="postSubmissionOptions">
            <button onclick="window.location.href='Profile.html'" class="btn">View Profile</button>
            <button onclick="window.location.href='ViewFuelHistory.html'" class="btn">View Fuel History</button>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const form = document.getElementById('fuelQuotaForm');
            form.addEventListener('submit', function(event) {
                event.preventDefault();
                submitFuelRequest();
            });

            loadDefaultAddress();
            addInputEventListeners();

            function submitFuelRequest() {
                const totalAmountDue = updateTotalAmountDue();
                const fuelRequestData = collectFormData(totalAmountDue);
                HistoryManager.addEntry(fuelRequestData);
                document.getElementById('postSubmissionOptions').style.display = 'block';
                alert('Fuel request submitted successfully!');
            }

            function collectFormData(totalAmountDue) {
                return {
                    gallonsRequested: parseInt(document.getElementById('gallonsRequested').value),
                    deliveryState: document.getElementById('deliveryState').value,
                    deliveryAddress: document.getElementById('deliveryAddress').value,
                    city: document.getElementById('city').value,
                    zipcode: document.getElementById('zipcode').value,
                    deliveryDate: document.getElementById('deliveryDate').value,
                    fuelType: document.getElementById('fuelType').options[document.getElementById('fuelType').selectedIndex].text,
                    pricePerGallon: calculatePricePerGallon(),
                    totalAmountDue
                };
            }

            function calculatePricePerGallon() {
                const basePrice = parseFloat(document.getElementById('fuelType').value);
                return (basePrice + calculateMargin(basePrice, document.getElementById('deliveryState').value, parseInt(document.getElementById('gallonsRequested').value))).toFixed(2);
            }

            function calculateMargin(pricePerGallon, deliveryState, gallonsRequested) {
                const locationFactor = deliveryState === 'TX' ? 0.02 : 0.04;
                const rateHistoryFactor = 0.01;
                const gallonsRequestedFactor = gallonsRequested > 1000 ? 0.02 : 0.03;
                const companyProfitFactor = 0.10;
                return pricePerGallon * (locationFactor - rateHistoryFactor + gallonsRequestedFactor + companyProfitFactor);
            }

            function addInputEventListeners() {
                ['input', 'change'].forEach(event => {
                    document.getElementById('gallonsRequested').addEventListener(event, updateTotalAmountDue);
                    document.getElementById('fuelType').addEventListener(event, updateTotalAmountDue);
                });
            }

            function updateTotalAmountDue() {
                const gallons = parseInt(document.getElementById('gallonsRequested').value || 0);
                const basePrice = parseFloat(document.getElementById('fuelType').value);
                const state = document.getElementById('deliveryState').value;
                const total = calculateTotalAmount(gallons, basePrice, state);
                document.getElementById('totalAmountDue').textContent = `$${total.toFixed(2)}`;
                return total;
            }

            function calculateTotalAmount(gallons, basePrice, state) {
                return gallons * (basePrice + calculateMargin(basePrice, state, gallons));
            }

            function loadDefaultAddress() {
                const username = sessionStorage.getItem('username');
                if (username) {
                    const userInfo = JSON.parse(localStorage.getItem(`userInfo_${username}`));
                    if (userInfo) {
                        document.getElementById('deliveryAddress').value = userInfo.address1 || '';
                        document.getElementById('city').value = userInfo.city || '';
                        document.getElementById('zipcode').value = userInfo.zipcode || '';
                        document.getElementById('deliveryState').value = userInfo.state || '';
                    }
                }
            }

            window.changeAddress = function() {
                document.getElementById('newAddressInput').style.display = 'block';
            };

            window.submitNewAddress = function() {
                const newAddress = document.getElementById('newAddress').value;
                if (newAddress) {
                    document.getElementById('deliveryAddress').value = newAddress;
                    document.getElementById('newAddressInput').style.display = 'none';
                } else {
                    alert("Please enter a valid address.");
                }
            };

            window.changeCity = function() {
                document.getElementById('newCityInput').style.display = 'block';
            };

            window.submitNewCity = function() {
                const newCity = document.getElementById('newCity').value;
                if (newCity) {
                    document.getElementById('city').value = newCity;
                    document.getElementById('newCityInput').style.display = 'none';
                } else {
                    alert("Please enter a valid city.");
                }
            };

            window.changeZipcode = function() {
                document.getElementById('newZipcodeInput').style.display = 'block';
            };

            window.submitNewZipcode = function() {
                const newZipcode = document.getElementById('newZipcode').value;
                if (newZipcode) {
                    document.getElementById('zipcode').value = newZipcode;
                    document.getElementById('newZipcodeInput').style.display = 'none';
                } else {
                    alert("Please enter a valid zipcode.");
                }
            };

            window.changeState = function() {
                document.getElementById('newStateInput').style.display = 'block';
            };

            window.submitNewState = function() {
                const newState = document.getElementById('newState').value;
                if (newState) {
                    document.getElementById('deliveryState').value = newState;
                    document.getElementById('newStateInput').style.display = 'none';
                } else {
                    alert("Please select a valid state.");
                }
            };
        });
    </script>
</body>
</html>
